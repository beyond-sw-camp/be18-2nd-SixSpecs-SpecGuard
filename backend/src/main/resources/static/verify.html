<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SpecGuard - 휴대폰 본인인증</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>body { background: #0b1220; }</style>
</head>
<body class="text-slate-100">
<div id="app" class="min-h-screen flex items-center justify-center p-6">
    <div class="bg-slate-900/50 rounded-2xl p-8 w-full max-w-3xl shadow-xl ring-1 ring-slate-800">
        <div class="flex flex-col md:flex-row gap-8">

            <!-- 왼쪽 -->
            <div class="flex-1">
                <h1 class="text-2xl font-extrabold mb-1">휴대폰 본인인증</h1>
                <p class="text-slate-400 mb-6">번호 입력 → 메시지 전송 → 자동 인증</p>

                <!-- 휴대폰 번호 -->
                <div class="mb-4">
                    <label class="block text-sm text-slate-400 mb-1">휴대폰 번호</label>
                    <input v-model.trim="state.phone"
                           class="w-full p-2 rounded bg-slate-800 ring-1 ring-slate-700"
                           placeholder="01012345678" inputmode="numeric" />
                </div>

                <!-- 버튼 -->
                <div class="flex gap-3 mb-4">
                    <button @click="start" class="px-4 py-2 rounded-xl bg-indigo-500 hover:bg-indigo-600 font-semibold">
                        인증번호 생성
                    </button>
                    <button @click="openSms" class="px-4 py-2 rounded-xl bg-sky-500 hover:bg-sky-600 font-semibold"
                            :disabled="!state.manualBody">
                        SMS 열기
                    </button>
                </div>

                <!-- 상태/TTL -->
                <div class="rounded-xl bg-slate-800 p-3 mb-3">
                    <div class="text-xs text-slate-400 mb-1">STATUS</div>
                    <div class="font-mono text-sm" :class="statusClass">{{ state.status }}</div>
                </div>

                <div class="rounded-xl bg-slate-800 p-3">
                    <div class="text-xs text-slate-400 mb-1">인증만료까지 남은시간</div>
                    <div class="font-mono text-sm">
                        {{ formattedLeft }} <span class="text-slate-500" v-if="state.totalSec">/ {{ formattedTotal }}</span>
                    </div>
                    <div class="mt-2 h-2 rounded bg-slate-700 overflow-hidden" v-if="state.totalSec">
                        <div class="h-2 bg-emerald-500 transition-all duration-300"
                             :style="{ width: ttlPercent + '%' }"></div>
                    </div>
                </div>

                <!-- 결과 메시지 -->
                <div v-if="state.message" class="mt-4 rounded-xl bg-slate-800 p-3 text-sm">
                    {{ state.message }}
                </div>

                <p class="mt-4 text-xs text-slate-500">
                    * SMS 수신자는 기기/OS 환경에 따라 직접 지정해야 할 수도 있습니다.
                </p>
            </div>

            <!-- 오른쪽: QR -->
            <div class="w-full md:w-64">
                <div class="rounded-2xl bg-slate-800 p-4 flex flex-col items-center">
                    <div id="qrcode" class="bg-white p-2 rounded shadow"></div>
                    <div class="mt-3 text-xs text-slate-400 text-center break-all">
                        API: {{ state.apiBase }}
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    const { createApp, reactive, computed, onMounted, onUnmounted } = Vue;

    createApp({
        setup() {
            const RECIPIENT_EMAIL = 'specguard55@gmail.com';

            const state = reactive({
                apiBase: 'http://192.168.0.39:8080',
                phone: '',
                channel: 'EMAIL_SMSTO',
                qrSmsto: '',
                smsLink: '',
                manualTo: '',
                manualBody: '',
                expiresAt: null,
                leftSec: 0,
                totalSec: 0,
                pollTimer: null,
                ttlTimer: null,
                status: 'IDLE',   // IDLE | PENDING | SUCCESS | EXPIRED | FAILED
                message: ''
            });

            const statusClass = computed(() =>
                state.status === 'SUCCESS' ? 'text-emerald-400'
                    : state.status === 'PENDING' ? 'text-yellow-300'
                        : state.status === 'EXPIRED' ? 'text-orange-400'
                            : state.status === 'FAILED'  ? 'text-rose-400'
                                : 'text-slate-300'
            );

            const formattedLeft  = computed(() => formatSec(state.leftSec));
            const formattedTotal = computed(() => formatSec(state.totalSec || 0));
            const ttlPercent = computed(() => {
                if (!state.totalSec) return 0;
                const p = (state.leftSec / state.totalSec) * 100;
                return Math.max(0, Math.min(100, p));
            });

            function normalizePhone(p) { return (p || '').replace(/\D/g, ''); }

            function renderQr() {
                const qrEl = document.getElementById("qrcode");
                if (!qrEl) return;
                qrEl.innerHTML = "";

                // manualBody는 서버에서 내려준 "인증번호: 123456 (5분 유효) PHONE:010..." 형식
                const body = state.manualBody || `인증번호: ${state.displayToken || ''} (5분 유효)`;
                const encoded = encodeURIComponent(body);

                // iOS 호환 우선 → sms: + 이메일 주소 + &body=
                const qrText = `sms:${RECIPIENT_EMAIL}&body=${encoded}`;

                new QRCode(qrEl, {
                    text: qrText,
                    width: 128,
                    height: 128,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
            }

            async function start() {
                stopTimers();
                const body = { phone: normalizePhone(state.phone), channel: state.channel };

                try {
                    const res = await fetch(`${state.apiBase}/api/verify/phone/start`, {
                        method: 'POST', headers: {'Content-Type':'application/json'},
                        body: JSON.stringify(body)
                    });
                    if (!res.ok) throw new Error(`start http ${res.status}`);
                    const data = await res.json();

                    state.qrSmsto    = data.qrSmsto ?? '';
                    state.smsLink    = data.smsLink ?? '';
                    state.manualTo   = data.manualTo ?? '';
                    state.manualBody = data.manualBody ?? '';

                    const sec = Number(data.expiresInSec ?? 0);
                    state.totalSec  = sec > 0 ? sec : 0;
                    state.expiresAt = sec > 0 ? new Date(Date.now() + sec * 1000) : null;

                    state.status = 'PENDING';
                    state.message = '인증번호가 생성되었습니다.';
                    renderQr();
                    startPolling();
                    startTtlCountdown();
                } catch (e) {
                    state.status = 'FAILED';
                    state.message = `Start 실패: ${e.message}`;
                }
            }

            function formatSec(s) {
                const n = Math.max(0, Number(s || 0));
                const mm = String(Math.floor(n / 60)).padStart(2, '0');
                const ss = String(n % 60).padStart(2, '0');
                return `${mm}:${ss}`;
            }

            function openSms() {
                if (!state.manualBody) return;
                const isiOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                const encoded = encodeURIComponent(state.manualBody);

                if (isiOS) {
                    window.location.href = `sms:${RECIPIENT_EMAIL}&body=${encoded}`;
                } else {
                    window.location.href = `mailto:${RECIPIENT_EMAIL}?body=${encoded}`;
                }
            }

            function startPolling() {
                fetchStatus();
                state.pollTimer = setInterval(fetchStatus, 2000);
            }

            function normalizeStatus(s) {
                const v = String(s || '').toUpperCase();
                if (['SUCCESS','VERIFIED','OK','DONE','PASS','PASSED','CONFIRMED'].includes(v)) return 'SUCCESS';
                if (['EXPIRED','TIMEOUT','NONE'].includes(v)) return 'EXPIRED';
                if (['FAILED','FAIL','ERROR','INVALID','MISMATCH'].includes(v)) return 'FAILED';
                if (['PENDING','WAITING','PROCESSING'].includes(v)) return 'PENDING';
                return 'PENDING';
            }

            async function fetchStatus() {
                const phone = normalizePhone(state.phone);
                if (!phone) return;

                try {
                    const url = `${state.apiBase}/api/verify/phone/status?phone=${encodeURIComponent(phone)}`;
                    const res = await fetch(url);
                    if (!res.ok) throw new Error(`status http ${res.status}`);
                    const data = await res.json();

                    const s = normalizeStatus(data.status);
                    state.status = s;

                    if (s !== 'PENDING') {
                        stopTimers();
                        if (s === 'SUCCESS') state.message = '인증 완료!';
                        if (s === 'EXPIRED') state.message = '인증번호가 만료되었습니다.';
                        if (s === 'FAILED')  state.message = '인증에 실패했습니다.';
                    }
                } catch (e) {
                    console.error(e);
                }
            }

            function startTtlCountdown() {
                updateLeftSec();
                state.ttlTimer = setInterval(updateLeftSec, 1000);
            }

            function updateLeftSec() {
                if (!state.expiresAt) { state.leftSec = 0; return; }
                const until = new Date(state.expiresAt).getTime();
                const now = Date.now();
                state.leftSec = Math.max(0, Math.floor((until - now) / 1000));
                if (state.leftSec === 0 && state.status === 'PENDING') {
                    state.status = 'EXPIRED';
                    state.message = '인증번호가 만료되었습니다.';
                    stopTimers();
                }
            }

            function stopTimers() {
                if (state.pollTimer) { clearInterval(state.pollTimer); state.pollTimer = null; }
                if (state.ttlTimer)  { clearInterval(state.ttlTimer);  state.ttlTimer  = null; }
            }

            onUnmounted(stopTimers);

            onMounted(() => {
                const url = new URL(window.location.href);
                const shouldOpen = url.searchParams.get("sms") === "1";
                if (shouldOpen) {
                    openSms();
                    url.searchParams.delete("sms");
                    window.history.replaceState({}, "", url.toString());
                }
            });

            return { state, statusClass, start, openSms, formattedLeft, formattedTotal, ttlPercent };
        }
    }).mount('#app');
</script>
</body>
</html>

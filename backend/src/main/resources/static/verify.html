<!doctype html>
<html lang="ko">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SpecGuard - íœ´ëŒ€í° ë³¸ì¸ì¸ì¦</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <!-- QRCodeJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        body { background: #0b1220; }
    </style>
</head>
<body class="text-slate-100">
<div id="app" class="min-h-screen flex items-center justify-center p-6">
    <div class="bg-slate-900/50 rounded-2xl p-8 w-full max-w-3xl shadow-xl ring-1 ring-slate-800">
        <div class="flex flex-col md:flex-row gap-8">

            <!-- ì™¼ìª½: ì„¤ëª… + í¼ -->
            <div class="flex-1">
                <h1 class="text-2xl font-extrabold mb-1">íœ´ëŒ€í° ë³¸ì¸ì¸ì¦ (Vue)</h1>
                <p class="text-slate-400 mb-6">ë²ˆí˜¸ ì…ë ¥ â†’ ë©”ì‹œì§€ ìë™ì‘ì„± â†’ ì „ì†¡ â†’ <span class="text-slate-200">ì¸ì¦í•˜ê¸°</span></p>

                <!-- íœ´ëŒ€í° ë²ˆí˜¸ -->
                <div class="mb-4">
                    <label class="block text-sm text-slate-400 mb-1">íœ´ëŒ€í° ë²ˆí˜¸</label>
                    <input v-model.trim="state.phone" class="w-full p-2 rounded bg-slate-800 ring-1 ring-slate-700"
                           placeholder="01012345678" inputmode="numeric" />
                </div>

                <!-- ë²„íŠ¼ë“¤ -->
                <div class="flex flex-wrap gap-3 mb-4">
                    <button @click="start" class="px-4 py-2 rounded-xl bg-indigo-500 hover:bg-indigo-600 font-semibold">
                        ì¸ì¦ ë©”ì‹œì§€ ìƒì„±
                    </button>
                    <button @click="openSms" class="px-4 py-2 rounded-xl bg-sky-500 hover:bg-sky-600 font-semibold">
                        SMS ì—´ê¸°
                    </button>
                    <button @click="finish" class="px-4 py-2 rounded-xl bg-emerald-500 hover:bg-emerald-600 font-semibold">
                        ì¸ì¦í•˜ê¸°
                    </button>
                </div>

                <!-- ì¸ì¦ë²ˆí˜¸ ì…ë ¥ ì¹¸ -->
<!--                <div class="mb-4">-->
<!--                    <label class="block text-sm text-slate-400 mb-1">ì¸ì¦ë²ˆí˜¸</label>-->
<!--                    <input v-model.trim="state.token"-->
<!--                           class="w-full p-2 rounded bg-slate-800 ring-1 ring-slate-700"-->
<!--                           placeholder="6ìë¦¬ ìˆ«ì"-->
<!--                           inputmode="numeric" />-->
<!--                </div>-->


                <!-- í† í°/ìƒíƒœ -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <div class="rounded-xl bg-slate-800 p-3">
                        <div class="text-xs text-slate-400 mb-1">TOKEN</div>
                        <div class="font-mono text-sm break-all">{{ state.token || '-' }}</div>
                    </div>
                    <div class="rounded-xl bg-slate-800 p-3">
                        <div class="text-xs text-slate-400 mb-1">STATUS</div>
                        <div class="font-mono text-sm" :class="statusClass">{{ state.status }}</div>
                    </div>
                </div>

                <!-- ê²°ê³¼ ë©”ì‹œì§€ -->
                <div v-if="state.message" class="mt-4 rounded-xl bg-slate-800 p-3 text-sm">
                    {{ state.message }}
                </div>

                <p class="mt-4 text-xs text-slate-500">
                    * ë¸Œë¼ìš°ì €/OS ì •ì±…ìƒ SMS ìˆ˜ì‹ ì ìë™ ì§€ì •ì´ ì œí•œë  ìˆ˜ ìˆìœ¼ë©°, ì‚¬ìš©ìê°€ ì§ì ‘ í™•ì¸/ì „ì†¡í•´ì•¼ í•©ë‹ˆë‹¤.
                </p>
            </div>

            <!-- ì˜¤ë¥¸ìª½: QR -->
            <div class="w-full md:w-64">
                <div class="rounded-2xl bg-slate-800 p-4 flex flex-col items-center">
                    <div id="qrcode" class="bg-white p-2 rounded shadow"></div>
                    <div class="mt-3 text-xs text-slate-400 text-center break-all">
                        API: {{ state.apiBase }}
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    const { createApp, reactive, computed, onMounted, onUnmounted } = Vue;

    createApp({
        setup() {
            const state = reactive({
                apiBase: 'http://192.168.0.21:8080',
                phone: '',
                channel: 'EMAIL_SMSTO',   // ì´ë©”ì¼(iMessage/ë©”ì¼)ë¡œ ë³´ë‚´ë ¤ë©´ ìœ ì§€
                displayToken: '',         // ì„œë²„ ìƒì„± 6ìë¦¬ (í‘œì‹œë§Œ)
                smsLink: '',
                smsBody: '',
                status: 'IDLE',           // IDLE | PENDING | VERIFIED | EXPIRED | FAILED
                message: '',
                pollTimer: null
            });

            const statusClass = computed(() =>
                state.status === 'VERIFIED' ? 'text-emerald-400'
                    : state.status === 'PENDING' ? 'text-yellow-300'
                        : state.status === 'EXPIRED' ? 'text-orange-400'
                            : state.status === 'FAILED'  ? 'text-rose-400'
                                : 'text-slate-300'
            );

            function normalizePhone(p) {
                return (p || '').replace(/[^0-9+]/g, '');
            }

            // 1) ì¸ì¦ ìš”ì²­
            async function start() {
                state.message = '';
                try {
                    const res = await fetch(`${state.apiBase}/api/verify/phone/start`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            phone: normalizePhone(state.phone),
                            channel: state.channel
                        })
                    });
                    if (!res.ok) throw res;
                    const data = await res.json();

                    state.displayToken = data?.token ?? '';   // í‘œì‹œë§Œ
                    state.smsLink      = data?.smsLink ?? '';
                    state.smsBody      = data?.manualBody ?? '';
                    state.status       = 'PENDING';
                    state.message      = 'ì¸ì¦ë²ˆí˜¸ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. SMSë¡œ ì „ì†¡ í›„ ìë™ í™•ì¸í•©ë‹ˆë‹¤.';

                    // ğŸ‘‰ í† í°ìœ¼ë¡œ ìƒíƒœ í´ë§ ì‹œì‘
                    if (state.displayToken) startPolling(state.displayToken);
                } catch (e) {
                    state.status = 'FAILED';
                    state.message = 'ì¸ì¦ë²ˆí˜¸ ìƒì„± ì‹¤íŒ¨';
                }
            }

            // 2) SMS ì—´ê¸° (ìˆ˜ì‹ ì²˜ ê³ ì •: specguard55@gmail.com)
            function openSms() {
                const isiOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
                const to    = 'specguard55@gmail.com'; // ê³ ì • ìˆ˜ì‹ ì²˜
                const bodyText = state.smsBody || `[SpecGuard] ì¸ì¦ë²ˆí˜¸: ${state.displayToken} (5ë¶„ ìœ íš¨)`;
                const body = encodeURIComponent(bodyText);

                // iOSëŠ” iMessageë¡œ ì´ë©”ì¼ ìˆ˜ì‹ ì í—ˆìš©, AndroidëŠ” mailtoë¡œ í´ë°±
                const href = isiOS ? `sms:${to}&body=${body}`
                    : `mailto:${to}?subject=${encodeURIComponent('[SpecGuard] ì¸ì¦ë²ˆí˜¸')}&body=${body}`;
                window.location.href = href;
            }

            // 3) ìƒíƒœ í´ë§
            function startPolling(token) {
                stopPolling();
                state.pollTimer = setInterval(async () => {
                    try {
                        const url = `${state.apiBase}/api/verify/phone/poll?token=${encodeURIComponent(token)}`;
                        const res = await fetch(url);
                        if (!res.ok) throw res;
                        const data = await res.json();
                        const s = (data?.status || '').toUpperCase();

                        if (s === 'VERIFIED') {
                            state.status = 'VERIFIED';
                            state.message = 'ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.';
                            stopPolling();
                        } else if (s === 'EXPIRED') {
                            state.status = 'EXPIRED';
                            state.message = 'ì¸ì¦ë²ˆí˜¸ê°€ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.';
                            stopPolling();
                        } else {
                            state.status = 'PENDING';
                        }
                    } catch (e) {
                        // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë“±ì€ ì¼ì‹œ ë¬´ì‹œí•˜ê³  ê³„ì† í´ë§
                    }
                }, 2000);
            }

            function stopPolling() {
                if (state.pollTimer) {
                    clearInterval(state.pollTimer);
                    state.pollTimer = null;
                }
            }

            onMounted(() => {
                // QRì€ ê·¸ëŒ€ë¡œ ìœ ì§€
                const el = document.getElementById('qrcode');
                el.innerHTML = '';
                new QRCode(el, {
                    text: "http://" + window.location.host + window.location.pathname,
                    width: 180, height: 180, correctLevel: QRCode.CorrectLevel.M
                });
            });

            onUnmounted(stopPolling);

            return { state, statusClass, start, openSms };
        }
    }).mount('#app');

</script>
</body>
</html>
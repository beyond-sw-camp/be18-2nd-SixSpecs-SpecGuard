<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SpecGuard - íœ´ëŒ€í° ë³¸ì¸ì¸ì¦</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <!-- QRCodeJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        body { background: #0b1220; }
    </style>
</head>
<body class="text-slate-100">
<div id="app" class="min-h-screen flex items-center justify-center p-6">
    <div class="bg-slate-900/50 rounded-2xl p-8 w-full max-w-3xl shadow-xl ring-1 ring-slate-800">
        <div class="flex flex-col md:flex-row gap-8">

            <!-- ì™¼ìª½: ì„¤ëª… + í¼ -->
            <div class="flex-1">
                <h1 class="text-2xl font-extrabold mb-1">íœ´ëŒ€í° ë³¸ì¸ì¸ì¦ (Vue)</h1>
                <p class="text-slate-400 mb-6">ë²ˆí˜¸ ì…ë ¥ â†’ ë©”ì‹œì§€ ìë™ì‘ì„± â†’ ì „ì†¡ â†’ <span class="text-slate-200">ì¸ì¦í•˜ê¸°</span></p>

                <!-- íœ´ëŒ€í° ë²ˆí˜¸ -->
                <div class="mb-4">
                    <label class="block text-sm text-slate-400 mb-1">íœ´ëŒ€í° ë²ˆí˜¸</label>
                    <input v-model.trim="state.phone" class="w-full p-2 rounded bg-slate-800 ring-1 ring-slate-700"
                           placeholder="01012345678" inputmode="numeric" />
                </div>

                <!-- ë²„íŠ¼ë“¤ -->
                <div class="flex flex-wrap gap-3 mb-4">
                    <button @click="start" class="px-4 py-2 rounded-xl bg-indigo-500 hover:bg-indigo-600 font-semibold">
                        ì¸ì¦ ë©”ì‹œì§€ ìƒì„±
                    </button>
                    <button @click="openSms" class="px-4 py-2 rounded-xl bg-sky-500 hover:bg-sky-600 font-semibold">
                        SMS ì—´ê¸°
                    </button>
                    <button @click="finish" class="px-4 py-2 rounded-xl bg-emerald-500 hover:bg-emerald-600 font-semibold">
                        ì¸ì¦í•˜ê¸°
                    </button>
                </div>

                <!-- í† í°/ìƒíƒœ -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <div class="rounded-xl bg-slate-800 p-3">
                        <div class="text-xs text-slate-400 mb-1">TID</div>
                        <div class="font-mono text-sm break-all">{{ state.tid || '-' }}</div>
                    </div>
                    <div class="rounded-xl bg-slate-800 p-3">
                        <div class="text-xs text-slate-400 mb-1">TOKEN</div>
                        <div class="font-mono text-sm break-all">{{ state.token || '-' }}</div>
                    </div>
                    <div class="rounded-xl bg-slate-800 p-3">
                        <div class="text-xs text-slate-400 mb-1">STATUS</div>
                        <div class="font-mono text-sm" :class="statusClass">{{ state.status }}</div>
                    </div>
                </div>

                <!-- ê²°ê³¼ ë©”ì‹œì§€ -->
                <div v-if="state.message" class="mt-4 rounded-xl bg-slate-800 p-3 text-sm">
                    {{ state.message }}
                </div>

                <p class="mt-4 text-xs text-slate-500">
                    * ë¸Œë¼ìš°ì €/OS ì •ì±…ìƒ SMS ìˆ˜ì‹ ì ìë™ ì§€ì •ì´ ì œí•œë  ìˆ˜ ìˆìœ¼ë©°, ì‚¬ìš©ìê°€ ì§ì ‘ í™•ì¸/ì „ì†¡í•´ì•¼ í•©ë‹ˆë‹¤.
                </p>
            </div>

            <!-- ì˜¤ë¥¸ìª½: QR -->
            <div class="w-full md:w-64">
                <div class="rounded-2xl bg-slate-800 p-4 flex flex-col items-center">
                    <div id="qrcode" class="bg-white p-2 rounded shadow"></div>
                    <div class="mt-3 text-xs text-slate-400 text-center break-all">
                        API: {{ state.apiBase }}
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    const { createApp, reactive, computed, onMounted } = Vue;

    createApp({
        setup() {
            const state = reactive({
                apiBase: 'http://192.168.0.21:8080', // ğŸ”’ ê³ ì • (ìˆ˜ì • ê°€ëŠ¥)
                phone: '',
                channel: 'EMAIL_SMSTO',             // ğŸ”’ ê³ ì •
                smsTo: 'specguard55@gmail.com',     // ğŸ”’ ê³ ì •
                tid: '',
                token: '',
                status: 'PENDING',
                message: ''
            });

            const statusClass = computed(() => {
                if (state.status === 'SUCCESS' || state.status === 'VERIFIED') return 'text-emerald-400';
                if (state.status === 'PENDING') return 'text-yellow-300';
                return 'text-rose-400';
            });

            function normalizePhone(p) {
                return (p || '').replace(/[^0-9+]/g, '');
            }

            // 1) ì¸ì¦ ë©”ì‹œì§€ ìƒì„±
            async function start() {
                state.message = '';
                const url = state.apiBase + '/api/verify/phone/start';
                try {
                    const res = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            phone: normalizePhone(state.phone),
                            channel: state.channel
                        })
                    });
                    if (!res.ok) throw new Error('start failed');
                    const data = await res.json();
                    state.tid   = data?.tid ?? data?.id ?? '';
                    state.token = data?.token ?? '';
                    state.status = data?.status ?? 'PENDING';
                    state.message = 'ì¸ì¦ ë©”ì‹œì§€ í…œí”Œë¦¿ ìƒì„± ì™„ë£Œ. SMSë¡œ ì „ì†¡í•´ ì£¼ì„¸ìš”.';
                } catch (e) {
                    console.error(e);
                    state.message = 'ì¸ì¦ ë©”ì‹œì§€ ìƒì„± ì‹¤íŒ¨';
                }
            }

            // 2) SMS ì—´ê¸°
            function openSms() {
                const body = encodeURIComponent(
                    `[SpecGuard] ë³¸ì¸ì¸ì¦ í† í°: ${state.token}\nìš”ì²­ID: ${state.tid}\nì´ ë©”ì‹œì§€ë¥¼ ê·¸ëŒ€ë¡œ ë³´ë‚´ ì¸ì¦ì„ ì™„ë£Œí•´ ì£¼ì„¸ìš”.`
                );

                const isiOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);

                let href = '';
                if (isiOS) {
                    // iOS(iMessage)ì—ì„œëŠ” ì´ë©”ì¼ ì£¼ì†Œë¥¼ ìˆ˜ì‹ ìì— ë„£ëŠ” ê²ƒì´ ë™ì‘
                    // í˜•ì‹: sms:ìˆ˜ì‹ ì&body=ë³¸ë¬¸  (ë¬¼ìŒí‘œ ì—†ì´ &body)
                    href = `sms:specguard55@gmail.com&body=${body}`;
                } else {
                    // ì•ˆë“œë¡œì´ë“œ/ê¸°íƒ€ â†’ ì´ë©”ì¼ ì£¼ì†Œ ìˆ˜ì‹ ì ì§€ì •ì´ ë§‰í˜€ ìˆìœ¼ë¯€ë¡œ ë³¸ë¬¸ë§Œ ì±„ì›Œì„œ ì—´ê¸°
                    href = `sms:&body=${body}`;
                }

                window.location.href = href;
            }

            // 3) ì¸ì¦í•˜ê¸°
            async function finish() {
                state.message = '';
                const url = state.apiBase + '/api/verify/phone/finish';
                try {
                    const res = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            tid: state.tid,
                            token: state.token,
                            phone: normalizePhone(state.phone)
                        })
                    });
                    const data = await res.json();
                    state.status = data?.status ?? 'UNKNOWN';
                    state.message = `ì„œë²„ ì‘ë‹µ: ${JSON.stringify(data)}`;
                } catch (e) {
                    console.error(e);
                    state.status = 'FAILED';
                    state.message = 'ì¸ì¦ ìš”ì²­ ì‹¤íŒ¨';
                }
            }

            // QR ìƒì„±
            function buildQr() {
                const el = document.getElementById('qrcode');
                el.innerHTML = '';
                new QRCode(el, {
                    text: window.location.href,
                    width: 180,
                    height: 180,
                    correctLevel: QRCode.CorrectLevel.M
                });
            }

            onMounted(buildQr);

            return { state, statusClass, start, openSms, finish };
        }
    }).mount('#app');
</script>
</body>
</html>